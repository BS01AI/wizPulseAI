# WizPulseAI SSO 认证系统测试文档

**版本**: v1.0
**日期**: 2025-10-31
**测试环境**: 本地开发环境 (localhost)

---

## 📋 测试概述

### 测试目标
验证 WizPulseAI 三站点 SSO（单点登录）系统的完整认证流程，确保：
- ✅ 邮件注册和登录正常工作
- ✅ Google OAuth 登录正常工作
- ✅ 跨站点认证状态同步（SSO）
- ✅ 单点登出（一处登出，全部登出）
- ✅ 密码管理功能正常

### 测试环境配置

| 站点 | 本地地址 | 端口 | 功能 |
|------|---------|------|------|
| Auth 站点 | http://localhost:3011 | 3011 | 认证中心 |
| Dashboard 站点 | http://localhost:3012 | 3012 | 用户仪表盘 |
| Main 站点 | http://localhost:3010 | 3010 | 主站 |

### Cookie 配置
- **本地环境**: `.localhost`
- **生产环境**: `.wizpulseai.com`

---

## 🧪 测试用例清单

### Test Suite 1: 邮件注册和登录流程

#### TC-001: 邮件注册（完整流程）

**前置条件**:
- 三个站点都已启动
- 使用全新的邮箱地址（未注册过）

**测试步骤**:

1. **访问认证中心**
   ```
   URL: http://localhost:3011/auth/sign-up
   ```

2. **填写注册信息**
   - 邮箱: `test-user-001@example.com`
   - 密码: `TestPass123!`
   - 确认密码: `TestPass123!`

3. **点击"Sign Up"按钮**
   - ✅ 显示"请检查邮箱完成验证"提示
   - ✅ 页面没有报错

4. **检查邮件**
   - 打开 Supabase Dashboard → Authentication → Users
   - 找到刚注册的用户
   - 点击"Send Magic Link"（开发环境手动验证）
   - 或者检查邮件收件箱

5. **点击验证链接**
   - ✅ 自动登录成功
   - ✅ 跳转到 Dashboard 或 Main 站点
   - ✅ 顶部显示用户信息

**预期结果**:
- ✅ 注册成功
- ✅ 邮件验证完成
- ✅ 自动登录，Cookie 已设置
- ✅ 用户信息正确显示

**失败案例**:
- ❌ 邮箱已存在：显示"User already registered"
- ❌ 密码不符合要求：显示密码强度提示
- ❌ 网络错误：显示连接失败提示

---

#### TC-002: 邮件登录（三个站点）

**前置条件**:
- 已完成 TC-001（用户已注册）
- 所有站点已登出

**测试步骤**:

**测试 2.1: Auth 站点登录**

1. 访问 `http://localhost:3011/auth/sign-in`
2. 输入邮箱和密码
3. 点击"Sign In"
4. ✅ 登录成功，跳转到 Dashboard/Main

**测试 2.2: Dashboard 站点登录**

1. 访问 `http://localhost:3012`
2. 点击"Login"按钮
3. 跳转到 Auth 站点登录页
4. 输入邮箱和密码登录
5. ✅ 自动跳回 Dashboard
6. ✅ 显示用户仪表盘

**测试 2.3: Main 站点登录**

1. 访问 `http://localhost:3010`
2. 点击"Login"按钮
3. 跳转到 Auth 站点登录页
4. 输入邮箱和密码登录
5. ✅ 自动跳回 Main 站点
6. ✅ 显示用户信息

**预期结果**:
- ✅ 所有站点都能正确登录
- ✅ 登录后自动跳回原站点
- ✅ Cookie 正确设置在 `.localhost` 域

---

#### TC-003: SSO 跨站点认证同步

**前置条件**:
- 已在 Auth 站点登录成功

**测试步骤**:

1. **在 Auth 站点登录**
   - 访问 `http://localhost:3011/auth/sign-in`
   - 登录成功

2. **打开 Dashboard 站点（新标签页）**
   - 访问 `http://localhost:3012`
   - ✅ **自动识别已登录**，无需再次登录
   - ✅ 直接显示用户仪表盘

3. **打开 Main 站点（新标签页）**
   - 访问 `http://localhost:3010`
   - ✅ **自动识别已登录**
   - ✅ 顶部显示用户信息和"Dashboard"链接

4. **验证 Cookie 共享**
   - 打开浏览器开发者工具 (F12)
   - 查看 Application → Cookies
   - ✅ 应该看到 `.localhost` 域下的 Supabase Cookie

**预期结果**:
- ✅ 一处登录，三个站点都自动登录
- ✅ 不需要重复输入账号密码
- ✅ Cookie 正确共享在顶级域

---

#### TC-004: 密码修改（仅邮件注册用户）

**前置条件**:
- 使用邮件注册的用户已登录
- **注意**: Google OAuth 用户无此功能

**测试步骤**:

1. **访问密码修改页面**
   - Dashboard: `http://localhost:3012/settings` (假设)
   - 或 Auth: `http://localhost:3011/auth/reset-password`

2. **填写信息**
   - 当前密码: `TestPass123!`
   - 新密码: `NewPass456!`
   - 确认新密码: `NewPass456!`

3. **提交修改**
   - ✅ 显示"密码修改成功"
   - ✅ 保持登录状态

4. **验证新密码**
   - 登出所有站点
   - 使用新密码登录
   - ✅ 登录成功

**预期结果**:
- ✅ 密码修改成功
- ✅ 旧密码立即失效
- ✅ 新密码可以正常登录

---

#### TC-005: 忘记密码（重置密码）

**前置条件**:
- 用户已注册但忘记密码
- 所有站点已登出

**测试步骤**:

1. **访问重置密码页面**
   - URL: `http://localhost:3011/auth/forgot-password`

2. **输入邮箱**
   - 邮箱: `test-user-001@example.com`
   - 点击"Send Reset Link"

3. **检查邮件**
   - 打开邮箱，找到重置密码邮件
   - 点击邮件中的重置链接

4. **设置新密码**
   - 输入新密码: `ResetPass789!`
   - 确认新密码: `ResetPass789!`
   - 点击"Reset Password"

5. **验证新密码**
   - ✅ 提示"密码重置成功"
   - ✅ 使用新密码登录成功

**预期结果**:
- ✅ 重置邮件发送成功
- ✅ 重置链接有效
- ✅ 新密码设置成功

---

### Test Suite 2: Google OAuth 登录流程

#### TC-006: Google OAuth 注册和登录

**前置条件**:
- 已配置 Google OAuth Client ID
- 使用全新的 Google 账号（未注册过）

**测试步骤**:

1. **访问认证中心**
   - URL: `http://localhost:3011/auth/sign-in`

2. **点击"Sign in with Google"**
   - ✅ 跳转到 Google 授权页面

3. **选择 Google 账号**
   - 选择一个 Google 账号
   - 授权应用访问

4. **自动完成注册和登录**
   - ✅ 自动返回应用
   - ✅ 自动创建用户账号
   - ✅ 自动登录成功

5. **检查用户信息**
   - ✅ 邮箱来自 Google 账号
   - ✅ 用户名/头像来自 Google

**预期结果**:
- ✅ OAuth 流程顺畅
- ✅ 用户信息自动填充
- ✅ 登录状态正确

**重要区别**:
- ❌ **没有密码修改功能**（Google 管理密码）
- ❌ **没有忘记密码功能**
- ✅ 其他功能（SSO、登出）与邮件用户相同

---

#### TC-007: Google OAuth 二次登录

**前置条件**:
- 已通过 Google OAuth 注册过（TC-006）
- 所有站点已登出

**测试步骤**:

1. **访问任意站点登录页**
   - Auth: `http://localhost:3011/auth/sign-in`
   - 或 Dashboard/Main 点击"Login"

2. **点击"Sign in with Google"**
   - ✅ 跳转到 Google 授权页

3. **选择已授权的 Google 账号**
   - ✅ **无需再次授权**（快速登录）
   - ✅ 自动返回应用

4. **验证登录状态**
   - ✅ 立即登录成功
   - ✅ 三个站点都已登录（SSO）

**预期结果**:
- ✅ 二次登录更快速
- ✅ 无需重复授权
- ✅ SSO 机制正常

---

### Test Suite 3: 单点登出测试

#### TC-008: 单点登出（All Sites Logout）

**前置条件**:
- 用户已在三个站点都登录（TC-003）

**测试步骤**:

1. **在 Dashboard 登出**
   - 访问 `http://localhost:3012`
   - 点击右上角用户菜单
   - 点击"Logout"按钮

2. **验证 Dashboard 登出**
   - ✅ 页面刷新
   - ✅ 显示"Login"按钮
   - ✅ 用户信息消失

3. **检查 Auth 站点**
   - 访问 `http://localhost:3011`
   - ✅ 显示未登录状态

4. **检查 Main 站点**
   - 访问 `http://localhost:3010`
   - ✅ 显示"Login"按钮
   - ✅ 用户信息消失

5. **验证 Cookie 清除**
   - F12 → Application → Cookies
   - ✅ Supabase Cookie 已删除

**预期结果**:
- ✅ **一处登出，全部登出**
- ✅ 所有站点都返回未登录状态
- ✅ Cookie 完全清除

---

#### TC-009: 跨站点登出测试（从不同站点登出）

**前置条件**:
- 用户已登录

**测试矩阵**:

| 登出位置 | Auth 状态 | Dashboard 状态 | Main 状态 | 结果 |
|---------|----------|---------------|----------|------|
| Auth 站点 | ❌ 已登出 | ❌ 已登出 | ❌ 已登出 | ✅ Pass |
| Dashboard | ❌ 已登出 | ❌ 已登出 | ❌ 已登出 | ✅ Pass |
| Main 站点 | ❌ 已登出 | ❌ 已登出 | ❌ 已登出 | ✅ Pass |

**测试步骤**:
1. 登录所有站点
2. 在任意一个站点点击"Logout"
3. 刷新其他两个站点
4. ✅ 所有站点都应该显示已登出

**预期结果**:
- ✅ 从任意站点登出，效果相同
- ✅ Cookie 在顶级域被清除

---

### Test Suite 4: 跨站点跳转测试

#### TC-010: 跨站点导航（已登录状态）

**前置条件**:
- 用户已登录

**测试步骤**:

1. **Auth → Dashboard 跳转**
   - 在 Auth 站点登录后
   - 点击"Go to Dashboard"链接
   - ✅ 跳转到 Dashboard
   - ✅ 保持登录状态

2. **Dashboard → Main 跳转**
   - 在 Dashboard 点击"Main Site"链接
   - ✅ 跳转到 Main 站点
   - ✅ 保持登录状态

3. **Main → Auth 跳转**
   - 在 Main 站点点击"Profile"
   - ✅ 跳转到 Auth 设置页
   - ✅ 保持登录状态

4. **循环跳转测试**
   - Auth → Dashboard → Main → Auth → ...
   - ✅ 多次跳转，登录状态始终保持

**预期结果**:
- ✅ 跨站点跳转流畅
- ✅ 登录状态不丢失
- ✅ 无需重复登录

---

#### TC-011: 跨站点跳转（未登录状态）

**前置条件**:
- 所有站点已登出

**测试步骤**:

1. **访问 Dashboard（未登录）**
   - URL: `http://localhost:3012`
   - ✅ 自动跳转到 Auth 登录页
   - ✅ 携带 returnUrl 参数

2. **登录后自动返回**
   - 在 Auth 站点完成登录
   - ✅ 自动跳回 Dashboard
   - ✅ 显示用户仪表盘

3. **访问 Main 受保护页面**
   - URL: `http://localhost:3010/profile`（假设需要登录）
   - ✅ 跳转到 Auth 登录页
   - 登录后 ✅ 自动返回原页面

**预期结果**:
- ✅ 未登录自动跳转到 Auth
- ✅ 登录后返回原访问页面
- ✅ returnUrl 参数正确传递

---

### Test Suite 5: 边界和异常测试

#### TC-012: 并发登录测试

**测试步骤**:
1. 在浏览器 A 登录
2. 在浏览器 B 用同一账号登录
3. ✅ 两个浏览器都能正常使用
4. 在浏览器 A 登出
5. ✅ 浏览器 B 保持登录（独立 Session）

**预期结果**:
- ✅ 支持多设备同时登录
- ✅ 登出不影响其他设备

---

#### TC-013: Session 过期测试

**测试步骤**:
1. 登录后长时间不操作（等待 Session 过期）
2. 刷新页面或操作
3. ✅ 提示"Session 已过期，请重新登录"
4. ✅ 自动跳转到登录页

**预期结果**:
- ✅ Session 过期后自动登出
- ✅ 提示信息友好

---

#### TC-014: Cookie 禁用测试

**测试步骤**:
1. 禁用浏览器 Cookie
2. 尝试登录
3. ✅ 提示"请启用 Cookie"
4. ✅ 无法完成登录

**预期结果**:
- ✅ 检测到 Cookie 禁用
- ✅ 给出明确提示

---

#### TC-015: 网络异常测试

**测试步骤**:
1. 断开网络连接
2. 尝试登录
3. ✅ 显示"网络连接失败"
4. 恢复网络后重试
5. ✅ 登录成功

**预期结果**:
- ✅ 网络错误有明确提示
- ✅ 恢复后功能正常

---

## 📊 测试用例对比总结

### 邮件注册 vs Google OAuth 对比

| 功能 | 邮件注册 | Google OAuth | 说明 |
|------|---------|--------------|------|
| 注册流程 | 手动填表 | 一键授权 | OAuth 更快 |
| 邮箱验证 | ✅ 需要 | ❌ 不需要 | Google 已验证 |
| 密码管理 | ✅ 支持 | ❌ 不支持 | OAuth 由 Google 管理 |
| 修改密码 | ✅ 支持 | ❌ 不支持 | - |
| 忘记密码 | ✅ 支持 | ❌ 不支持 | - |
| SSO 跨站点 | ✅ 支持 | ✅ 支持 | 功能相同 |
| 单点登出 | ✅ 支持 | ✅ 支持 | 功能相同 |
| 用户信息 | 手动输入 | Google 同步 | OAuth 自动填充头像 |

---

## ✅ 测试检查清单

### 功能测试

- [ ] TC-001: 邮件注册流程
- [ ] TC-002: 邮件登录（三个站点）
- [ ] TC-003: SSO 跨站点认证同步
- [ ] TC-004: 密码修改
- [ ] TC-005: 忘记密码
- [ ] TC-006: Google OAuth 注册和登录
- [ ] TC-007: Google OAuth 二次登录
- [ ] TC-008: 单点登出
- [ ] TC-009: 跨站点登出测试
- [ ] TC-010: 跨站点跳转（已登录）
- [ ] TC-011: 跨站点跳转（未登录）

### 异常测试

- [ ] TC-012: 并发登录测试
- [ ] TC-013: Session 过期测试
- [ ] TC-014: Cookie 禁用测试
- [ ] TC-015: 网络异常测试

### 兼容性测试

- [ ] Chrome 浏览器测试
- [ ] Safari 浏览器测试
- [ ] Firefox 浏览器测试
- [ ] Edge 浏览器测试
- [ ] 移动端浏览器测试

---

## 🐛 问题记录模板

测试过程中发现问题，请使用以下模板记录：

```markdown
### BUG-001: [问题简述]

**测试用例**: TC-XXX
**严重程度**: 高/中/低
**复现步骤**:
1. 步骤1
2. 步骤2
3. 步骤3

**预期结果**: XXX
**实际结果**: XXX
**截图**: (附上截图)
**浏览器**: Chrome 120.0
**环境**: 本地开发环境
**日志**: (相关日志)
```

---

## 📝 测试报告模板

测试完成后，生成测试报告：

```markdown
# WizPulseAI SSO 测试报告

**测试日期**: 2025-10-31
**测试人员**: [姓名]
**测试环境**: 本地开发环境

## 测试结果汇总

- 总用例数: 15
- 通过: XX
- 失败: XX
- 阻塞: XX
- 通过率: XX%

## 功能测试结果

| 测试用例 | 结果 | 备注 |
|---------|------|------|
| TC-001 | ✅ Pass | - |
| TC-002 | ✅ Pass | - |
| TC-003 | ❌ Fail | Cookie 未共享 |
| ... | ... | ... |

## 主要问题

1. [BUG-001]: Cookie 跨域问题
2. [BUG-002]: 登出后跳转错误
3. ...

## 建议改进

1. 优化登录页面加载速度
2. 增加加载状态提示
3. ...
```

---

## 🔗 相关文档

- [LOCAL_TEST_GUIDE.md](../LOCAL_TEST_GUIDE.md) - 本地测试环境搭建
- [NEXT_STEPS.md](../NEXT_STEPS.md) - 后续开发计划
- [CLAUDE.md](../CLAUDE.md) - 项目技术架构

---

**文档维护**: 测试用例应随功能迭代持续更新
